[&#8617; 返回总览](../README.md)

---

## 5. 游戏状态与进程管理

本节涵盖控制游戏整体流程、单次运行状态和元进度的高层级管理器。

### 5.1. `GameManager`：用于游戏流程的有限状态机

一个游戏通常具有多个明确的状态，如主菜单、游戏中、暂停、游戏结束等。有限状态机（Finite State Machine, FSM）是管理这些离散状态转换的经典且稳固的设计模式。

我们将实现一个`GameManager`自动加载单例，其内部逻辑将基于一个有限状态机。这个管理器将负责处理最高级别的游戏流程控制，例如：
* 开始一次新的游戏运行（`new_run`），这将触发`MapGenerator`开始工作。
* 处理游戏的暂停（`pause_game`）和恢复（`resume_game`）。
* 响应玩家死亡事件，并切换到游戏结束状态（`game_over`）。

`GameManager`将主要通过全局`Events`事件总线与其他系统进行通信，以保持低耦合。例如，当玩家死亡时，`Player`实体可能会向事件总线发出`player_died`事件，`GameManager`监听到此事件后，便会触发状态转换。

### 5.2. 生成逻辑：`SpawnProfile`资源与对象池

敌人的生成逻辑需要一个管理器来控制生成的时机、位置和类型。生成规则可以数据化地定义，例如通过设定波次、点数系统和允许的敌人类型来控制难度曲线。

* **`SpawnProfile.gd` (extends `Resource`)**: 这是一个数据资源，用于定义一个关卡或区域中可以生成的实体类型及其概率。它将包含一个加权的`EntityData`资源列表。
* **`Spawner.gd`**: 这是一个由`GameManager`管理的系统或节点。它接收一个`SpawnProfile`和一个`MapData`对象，并负责根据生成规则在地图的有效位置上生成敌人。

在游戏中频繁地实例化和销毁节点（`instantiate()`和`queue_free()`）是一项性能开销很大的操作，尤其是在需要生成大量敌人或射弹的场景中。对象池（Object Pooling）是解决此问题的标准方案。

* **`ObjectPool.gd`**: 一个自动加载单例，负责管理预先实例化好的场景对象池（如不同类型的敌人、射弹、视觉效果等）。当`Spawner`需要一个敌人时，它会向`ObjectPool`请求一个，而不是直接调用`instantiate()`。当一个敌人“死亡”时，它不会被`queue_free()`销毁，而是被禁用并返回到对象池中以待复用。这个过程需要一个严格的状态重置机制，以确保从池中取出的对象处于干净的初始状态。

### 5.3. `SaveManager`：持久化运行与元进度数据

对于保存游戏数据，特别是复杂的自定义数据结构，强烈推荐使用Godot内置的`ResourceSaver`和`ResourceLoader`，它们比通用的数据格式（如JSON）更高效、更安全，并且能无缝处理Godot的内置类型。

在设计保存系统时，必须对游戏状态的“易失性”进行关键区分。游戏数据可以分为三类：
1.  **易失状态（Volatile State）**: 瞬时数据，如敌人的当前位置、射弹的飞行轨迹。这类数据完全没有保存的必要。
2.  **运行状态（Run State）**: 在单次游戏运行中持续存在的数据，如当前生成的地图布局、玩家在本局游戏中的生命值和物品。在典型的Roguelike中，这类数据通常在运行结束后被丢弃。
3.  **持久状态（Persistent State）**: 需要在多次游戏运行之间保持的数据，即元进度（Meta-progression），如已解锁的角色、永久性升级、全局货币等。这是Roguelike游戏长期吸引力的关键。

**RogueKit** 的保存系统架构将严格遵循这一区分。`SaveManager`的设计目标是*只*关心持久状态。

* **`MetaProgressionData.gd` (extends `Resource`)**: 创建一个专门的`Resource`类，用于封装所有需要跨运行持久化的数据。
* **`SaveManager.gd`**: 一个自动加载单例，提供`save_game()`和`load_game()`方法。这些方法内部将使用`ResourceSaver.save()`和`ResourceLoader.load()`来将`MetaProgressionData`资源实例序列化到`user://`目录下的一个文件中。

这种设计极大地简化了保存系统的复杂性。它避免了尝试序列化整个动态场景树的陷阱，并与Roguelike“每局都是新开始”的核心玩法保持一致。